# CVE-2010-2553 Media Player堆溢出漏洞复现

## 测试环境

|            | 推荐环境                | 版本                 |
| ---------- | ----------------------- | -------------------- |
| 操作系统   | Windows XP Professional | Service Pack 3 (x86) |
| 漏洞软件   | Microsoft Media Player  | 10.00.00.3802        |
| 虚拟机     | VMware                  | 16.2.3               |
| 调试器     | windbg                  | 6.12.0002.633 x86    |
| 反汇编工具 | IDA Pro                 | 7.7                  |

影响范围：

| 操作系统                                                     |
| :----------------------------------------------------------- |
| Windows XP Service Pack 3                                    |
| Windows XP Professional x64 Edition Service Pack 2           |
| Windows Vista Service Pack 1 and Windows Vista Service Pack 2 |
| Windows Vista x64 Edition Service Pack 1 and Windows Vista x64 Edition Service Pack 2 |
| Windows 7 for 32-bit Systems                                 |
| Windows 7 for x64-based Systems                              |

## 环境搭建

https://msdn.itellyou.cn/

Windows XP Professional with Service Pack 3 (x86)

```
ed2k://|file|zh-hans_windows_xp_professional_with_service_pack_3_x86_cd_x14-80404.iso|630239232|CD0900AFA058ACB6345761969CBCBFF4|/
```

[Microsoft Media Player 10 下载地址](https://www.windows-media-player.com/wmplayer-10/)

## 漏洞复现&分析

首先打开`Windows Media Player`，然后用`WinDbg`附加进程`wmplayer.exe`，然后通过`!gflag +hpa`命令`开启页堆`，通过`页堆(HeapPage)`进行`堆溢出漏洞`的调试。

结果发现报错

```
>!gflag +hpa
Could not find NtGlobalFlag in nt!_PEB
```

这是程序的反调试机制，需要把gflag放在C:\Program Files\Windows Media Player目录中

![image-20220915145129514](CVE-2010-2553.assets/image-20220915145129514.png)

再打开wmplayer.exe，使用WinDbg附加进程，使用g运行，打开我们的poc.avi，程序在此处断下

![image-20220915150846113](CVE-2010-2553.assets/image-20220915150846113.png)

此时的edi指向的内存的内存状态(State)为MEM_RESERVE，即保留内存，保留内存尚不能被实际使用，但其地址空间已被预留，尚需一个提交动作。所以edi指向的内存是不能访问的。

```
0:012> !address 12233000
Usage:                  <unclassified>
Allocation Base:        12150000
Base Address:           12233000
End Address:            12234000
Region Size:            00001000
Type:                   00020000	MEM_PRIVATE
State:                  00001000	MEM_COMMIT
Protect:                00000001	PAGE_NOACCESS
```

我们查看一手栈回溯

```
0:012> kb
ChildEBP RetAddr  Args to Child              
WARNING: Stack unwind information not available. Following frames may be wrong.
1233fd30 73b7cbf3 00000004 00000000 00000068 iccvid+0x22cc
1233fd60 73b766c8 09ee7f60 00000000 09ee9fd8 iccvid!DllInstanceInit+0x6279
1233fdac 73b41938 09ee7f60 00000001 0000400d iccvid!DriverProc+0x1bf
1233fdd0 7cf8fa9e 73b5b500 0000400d 1233fde8 MSVFW32!ICSendMessage+0x2b
1233fe00 7cf8f9e9 73b5b500 00000000 09ee9fd8 quartz+0x1fa9e
1233fec0 7cf90a55 0a006fa8 09976c90 00000000 quartz+0x1f9e9
1233feec 7cf90939 0a006fa8 00000000 09f2eee0 quartz+0x20a55
1233ff00 7cf8e67a 05776f44 0a006fa8 1233ff40 quartz+0x20939
1233ff10 7cf90ca0 0a006fa8 00040103 09f2eee0 quartz+0x1e67a
1233ff40 7cf90e1c 1233ff70 1233ff6c 7c984d69 quartz+0x20ca0
1233ff84 7cf8ce30 7c984d69 09f2eee0 09f2eee0 quartz+0x20e1c
1233ff9c 7cf8dbe6 00000000 7cf8a121 7c984d69 quartz+0x1ce30
1233ffb4 7c80b713 09f2eee0 7c984d69 00000010 quartz+0x1dbe6
1233ffec 00000000 7cf8a10c 09f2eee0 00000000 kernel32!GetModuleFileNameA+0x1b4
```

获取到上一层,通过ub命令找到上一层调用

![image-20220915152952873](CVE-2010-2553.assets/image-20220915152952873.png)

通过以上调试信息，可以看出0x73b722cc处的内存复制指令发生内存访问异常，调用该函数的指令位于iccvid.dll中的DllInstanceInit+0x6279处，也就是地址0x73b7cbee处，我们需要对此地址下断点，才能进入此函数，分析其功能。但是，由于该地址位于iccvid.dll模块中，而iccvid.dll只有在解析poc.avi时才会被动态加载。若重新附加进程，是未加载iccvid.dll模块的，这里有两种解决方案。

```
1、利用OllyDbg或Immunity Debugger调试器加载iccvid.dll，F9键运行后对地址0x73b7cbee下断点，然后附加wmplayer.exe，F9运行后重新打开poc.avi，就会断在地址0x73b7cbee处。
2、利用WinDbg的sxe ld:ModuleName命令，可以在首次加载iccvid.dll时断下，然后可以对地址0x73b7cbee下断点。
```

这里使用第2种方法，在使用sxe ld:ModuleName命令后，会中断在iccvid.dll加载后调用的ntdll!KiFastSystemCallRet函数处。

sxe命令的功能为，发生此异常时，目标会在激活任何其他错误处理程序之前立即中断调试器。 这种处理称为第一次机会处理。

ld[:Module]，如果指定了Module，则当名字为指定值的模块加载时发生中断。如果没有指定Module，任何模块加载时都会中断。

重新加载，使用sxe命令

![image-20220915163305187](CVE-2010-2553.assets/image-20220915163305187.png)

查看是否成功中断，成功之后在73b7cbee处下断点

![image-20220915163558127](CVE-2010-2553.assets/image-20220915163558127.png)

接着用g运行，单步跟踪查看

```assembly
0:008> g
Breakpoint 0 hit
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b7cbee esp=135efd38 ebp=135efd60 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid!DllInstanceInit+0x6274:
73b7cbee e8bb55ffff      call    iccvid+0x21ae (73b721ae)
0:014> t
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721ae esp=135efd34 ebp=135efd60 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21ae:
73b721ae 8bff            mov     edi,edi
0:014> p
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721b0 esp=135efd34 ebp=135efd60 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21b0:
73b721b0 55              push    ebp
0:014> p
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721b1 esp=135efd30 ebp=135efd60 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21b1:
73b721b1 8bec            mov     ebp,esp
0:014> p
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721b3 esp=135efd30 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21b3:
73b721b3 83ec20          sub     esp,20h
0:014> p
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721b6 esp=135efd10 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21b6:
73b721b6 53              push    ebx
0:014> p
eax=00000001 ebx=135efd88 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721b7 esp=135efd0c ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21b7:
73b721b7 8b5d08          mov     ebx,dword ptr [ebp+8] ss:0023:135efd38=133cdfc0
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721ba esp=135efd0c ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21ba:
73b721ba 56              push    esi
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=09966f60 edi=11e60800
eip=73b721bb esp=135efd08 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21bb:
73b721bb 8b7324          mov     esi,dword ptr [ebx+24h] ds:0023:133cdfe4=00000000
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=11e60800
eip=73b721be esp=135efd08 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21be:
73b721be 57              push    edi
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=11e60800
eip=73b721bf esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21bf:
73b721bf 33ff            xor     edi,edi
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=00000000
eip=73b721c1 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21c1:
73b721c1 3bf7            cmp     esi,edi
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=00000000
eip=73b721c3 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21c3:
73b721c3 741c            je      iccvid+0x21e1 (73b721e1)                [br=1]
0:014> p
eax=00000001 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=00000000
eip=73b721e1 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21e1:
73b721e1 33c0            xor     eax,eax #eax清零
0:014> p
eax=00000000 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=00000000
eip=73b721e3 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21e3:
73b721e3 837d1020        cmp     dword ptr [ebp+10h],20h ss:0023:135efd40=00000068 #比较CVID数据长度是否小于0x20，下面有文件解析
0:014> p
eax=00000000 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=00000000
eip=73b721e7 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x21e7:
73b721e7 0f8200020000    jb      iccvid+0x23ed (73b723ed)                [br=0]
0:014> p
eax=00000000 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=00000000 edi=00000000
eip=73b721ed esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x21ed:
73b721ed 8b750c          mov     esi,dword ptr [ebp+0Ch] ss:0023:135efd3c=097c0af8 #指向PoC中的cinepak_codec_data1 数据
0:014> dd 097c0af8
097c0af8  68000000 20016001 00101000 00001000
097c0b08  60000000 00206001 00110000 41411000
097c0b18  41414141 41414141 00114141 41411000
097c0b28  41414141 41414141 00114141 41411000
097c0b38  41414141 41414141 00114141 00411000
097c0b48  31786469 00000010 63643030 00000010
097c0b58  00000004 00000068 c0c0c0c0 c0c0c0c0
097c0b68  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0
0:014> p
eax=00000000 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b721f0 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x21f0:
73b721f0 8a6601          mov     ah,byte ptr [esi+1]        ds:0023:097c0af9=00
0:014> p
eax=00000000 ebx=133cdfc0 ecx=0005e2c0 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b721f3 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x21f3:
73b721f3 0fb64e03        movzx   ecx,byte ptr [esi+3]       ds:0023:097c0afb=68
0:014> p
eax=00000000 ebx=133cdfc0 ecx=00000068 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b721f7 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x21f7:
73b721f7 8a4602          mov     al,byte ptr [esi+2]        ds:0023:097c0afa=00
0:014> p
eax=00000000 ebx=133cdfc0 ecx=00000068 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b721fa esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x21fa:
73b721fa c1e008          shl     eax,8
0:014> p
eax=00000000 ebx=133cdfc0 ecx=00000068 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b721fd esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x21fd:
73b721fd 0bc1            or      eax,ecx #检查长度的高位是否存在数值
0:014> p
eax=00000068 ebx=133cdfc0 ecx=00000068 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b721ff esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x21ff:
73b721ff 394510          cmp     dword ptr [ebp+10h],eax ss:0023:135efd40=00000068 #判断CVID数据长度是否为正整数，因为长度值必须为无符号整数
0:014> p
eax=00000068 ebx=133cdfc0 ecx=00000068 edx=fffffee0 esi=097c0af8 edi=00000000
eip=73b72202 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2202:
73b72202 0f8cec010000    jl      iccvid+0x23f4 (73b723f4)                [br=0] #不跳转
```

通过动调，我们可以看到代码主要检测CVID的数据长度是否大于0x20，只有大于0x20才能继续往下执行，否则返回函数。我们结合着AVI的Cinepak压缩格式来看看。Cinepak（CVID）压缩格式的总体框架：

![image-20220916110941861](CVE-2010-2553.assets/image-20220916110941861.png)

其中Frame Header内部各个字段的定义

![image-20220916135934049](CVE-2010-2553.assets/image-20220916135934049.png)

```
1字节 Flags  - Flags字段的位0指定每个条(Strip)的codebooks是否使用上一个条(Strip)中定义的codebooks。对于Frame的第一个Strip，先前的Strip可以在先前的Frame中找到。
3字节 Length -CVID 数据长度 此字段指定Frame中的字节总数。
2字节 Width -编码帧宽度 Frame的像素宽度。
2字节 Height -编码帧高度 Frame的像素高度。
2字节 Number of Strips -编码条数量 用于对Frame进行编码的条(Strips)总数。
```

在poc.avi中的cinepak_codec_datal就是Cinepak数据的开始，即Frame_Header = cinepak_codec_data1 + number_of_coded_strips，因此各字段值对应如下:

```
68000000 20016001 00101000 00001000
Flag = 00
CVID 数据长度 = 00 00 68
编码帧宽度 = 01 60
编码帧高度= 01 20
编码条数量 =  00 10
```

所以我们知道0x68代表了CVID数据长度。接下来，我们继续分析，为了方便阅读代码，我们使用ida进行反汇编

```assembly
.text:73B72208 8A 0E                         mov     cl, [esi]
.text:73B7220A 88 4D 13                      mov     byte ptr [ebp+arg_8+3], cl
.text:73B7220D 8D 4D F0                      lea     ecx, [ebp+var_10]
.text:73B72210 51                            push    ecx   	#ecx = 0
.text:73B72211 6A 0A                         push    0Ah
.text:73B72213 50                            push    eax	#eax = 0x68
.text:73B72214 E8 6D FF FF FF                call    sub_73B72186	#ULongSub(x,x,x)
.text:73B72214
.text:73B72219 85 C0                         test    eax, eax	#eax = 0
.text:73B7221B 0F 8C D3 01 00 00             jl      loc_73B723F4
.text:73B7221B
.text:73B72221 33 C0                         xor     eax, eax
.text:73B72223 8A 66 08                      mov     ah, [esi+8]	#0
.text:73B72226 83 C6 0A                      add     esi, 0Ah	#esi指向cinepak_codec_data2
.text:73B72229 89 7D EC                      mov     [ebp+var_14], edi	#edi
.text:73B7222C 89 75 E8                      mov     [ebp+var_18], esi
.text:73B7222F 89 75 F4                      mov     [ebp+var_C], esi
.text:73B72232 8A 46 FF                      mov     al, [esi-1]	#al = 0x10，即编码条数量
.text:73B72235 3B C7                         cmp     eax, edi	#判断编码条数量是否大于0
.text:73B72237 89 45 E4                      mov     [ebp+var_1C], eax
.text:73B7223A 0F 8E AA 01 00 00             jle     loc_73B723EA	#不跳转
.text:73B7223A
.text:73B72240 89 7D FC                      mov     [ebp+var_4], edi
```

继续回头看下Cinepak (CVID)压缩格式，在Frame Header之后是一些编码条，每一个编码条包含Header和CVID Chunk两部分，CodeBooks和Frame Vectors就包含在CVID Chunk部分，编码条各字段的含义如下。

![image-20220916143552883](CVE-2010-2553.assets/image-20220916143552883.png)

```c
097c0b02  10000010 00000000 60016000 00000020
097c0b12  10000011 41414141 41414141 41414141
097c0b22  10000011 41414141 41414141 41414141
097c0b32  10000011 41414141 41414141 41414141
097c0b42  10000011 64690041 00103178 30300000
097c0b52  00106364 00040000 00680000 c0c00000
097c0b62  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0
097c0b72  c0c0c0c0 c0c0c0c0 c0c0c0c0 c0c0c0c0
编码条ID = 10 00，代表Intra-coded strip
编码条数据大小 = 00 10
顶部Y坐标 = 00 00
顶部X坐标 = 00 00
底部Y坐标 = 00 60
底部X坐标 = 01 60
CVID Chunk ID = 20 00，代表12位 v4 codebook 块列表
chunk数据大小 = 00 00
cVID Chunk ID = 11 00 
Chunk数据大小 = 00 10
Chunk数据 = AAAAAAAAAAAA (12字节)
CVID Chunk ID = 11 00
chunk数据大小 = 00 10
Chunk数据 = AAAAAAAAAAAA(12字节)
CVID Chunk ID = 11 00
Chunk数据大小 = 00 10
Chunk数据 = AAAAAAAAAAAA（12字节)
```

使用windbg继续走下去

```assembly
0:014> p
eax=00000010 ebx=133cdfc0 ecx=0000005e edx=135efd20 esi=097c0b02 edi=00000000
eip=73b72243 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x2243:
73b72243 8b45f0          mov     eax,dword ptr [ebp-10h] ss:0023:135efd20=0000005e	#未解压缩的数据长度，开始长度等于Poc中的cinepak_codec_data2字节数
0:014> p
eax=0000005e ebx=133cdfc0 ecx=0000005e edx=135efd20 esi=097c0b02 edi=00000000
eip=73b72246 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x2246:
73b72246 83f816          cmp     eax,16h #判断为解压的数据长度是否大于等于0x16
0:014> p
eax=0000005e ebx=133cdfc0 ecx=0000005e edx=135efd20 esi=097c0b02 edi=00000000
eip=73b72249 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x2249:
73b72249 0f829b010000    jb      iccvid+0x23ea (73b723ea)                [br=0]
0:014> p
eax=0000005e ebx=133cdfc0 ecx=0000005e edx=135efd20 esi=097c0b02 edi=00000000
eip=73b7224f esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x224f:
73b7224f 0fb65603        movzx   edx,byte ptr [esi+3]       ds:0023:097c0b05=10
0:014> p
eax=0000005e ebx=133cdfc0 ecx=0000005e edx=00000010 esi=097c0b02 edi=00000000
eip=73b72253 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x2253:
73b72253 33c9            xor     ecx,ecx
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000000 edx=00000010 esi=097c0b02 edi=00000000
eip=73b72255 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2255:
73b72255 8a6e01          mov     ch,byte ptr [esi+1]        ds:0023:097c0b03=00
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000000 edx=00000010 esi=097c0b02 edi=00000000
eip=73b72258 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2258:
73b72258 8a4e02          mov     cl,byte ptr [esi+2]        ds:0023:097c0b04=00
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000000 edx=00000010 esi=097c0b02 edi=00000000
eip=73b7225b esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x225b:
73b7225b c1e108          shl     ecx,8
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000000 edx=00000010 esi=097c0b02 edi=00000000
eip=73b7225e esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x225e:
73b7225e 0bca            or      ecx,edx
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000010 edx=00000010 esi=097c0b02 edi=00000000
eip=73b72260 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x2260:
73b72260 3bc1            cmp     eax,ecx #检查为解压的数据大小是否小于0x10
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000010 edx=00000010 esi=097c0b02 edi=00000000
eip=73b72262 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x2262:
73b72262 894df8          mov     dword ptr [ebp-8],ecx ss:0023:135efd28=00000004
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000010 edx=00000010 esi=097c0b02 edi=00000000
eip=73b72265 esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x2265:
73b72265 0f827f010000    jb      iccvid+0x23ea (73b723ea)                [br=0]
0:014> p
eax=0000005e ebx=133cdfc0 ecx=00000010 edx=00000010 esi=097c0b02 edi=00000000
eip=73b7226b esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x226b:
73b7226b 8a06            mov     al,byte ptr [esi]          ds:0023:097c0b02=10
0:014> p
eax=00000010 ebx=133cdfc0 ecx=00000010 edx=00000010 esi=097c0b02 edi=00000000
eip=73b7226d esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x226d:
73b7226d 3c10            cmp     al,10h
0:014> p
eax=00000010 ebx=133cdfc0 ecx=00000010 edx=00000010 esi=097c0b02 edi=00000000
eip=73b7226f esp=135efd04 ebp=135efd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x226f:
73b7226f 7408            je      iccvid+0x2279 (73b72279)                [br=1]
```

此处跳转并不会触发前面异常的0x73b722cc，执行到尾部的时候，他会再跳转回0x73b72243

```assembly
0:013> p
eax=00000010 ebx=11f4afc0 ecx=09e98b0e edx=00000000 esi=09e98b12 edi=00000000
eip=73b723de esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x23de:
73b723de 3945ec          cmp     dword ptr [ebp-14h],eax ss:0023:137bfd1c=00000001
0:013> p
eax=00000010 ebx=11f4afc0 ecx=09e98b0e edx=00000000 esi=09e98b12 edi=00000000
eip=73b723e1 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei ng nz na po cy
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000283
iccvid+0x23e1:
73b723e1 8975e8          mov     dword ptr [ebp-18h],esi ss:0023:137bfd18=09e98b0e
0:013> p
eax=00000010 ebx=11f4afc0 ecx=09e98b0e edx=00000000 esi=09e98b12 edi=00000000
eip=73b723e4 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei ng nz na po cy
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000283
iccvid+0x23e4:
73b723e4 0f8c59feffff    jl      iccvid+0x2243 (73b72243)                [br=1]
0:013> p
eax=00000010 ebx=11f4afc0 ecx=09e98b0e edx=00000000 esi=09e98b12 edi=00000000
eip=73b72243 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei ng nz na po cy
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000283
iccvid+0x2243:
73b72243 8b45f0          mov     eax,dword ptr [ebp-10h] ss:0023:137bfd20=0000004e #循环处理剩余的未解压数据，每次处理0x10字节
```

继续执行下去又回到0x73b7226d地址，当Chunk ID=0x1100时，就会执行前面异常地址0x736722cc处的堆数据复制指令：

```assembly
eax=0000004e ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b7226b esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x226b:
73b7226b 8a06            mov     al,byte ptr [esi]          ds:0023:09e98b12=11
0:013> p
eax=00000011 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b7226d esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x226d:
73b7226d 3c10            cmp     al,10h
0:013> p
eax=00000011 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b7226f esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x226f:
73b7226f 7408            je      iccvid+0x2279 (73b72279)                [br=0]
0:013> p
eax=00000011 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b72271 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x2271:
73b72271 3c11            cmp     al,11h #当Chunk ID = 0x1100时，不发生跳转
0:013> p
eax=00000011 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b72273 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2273:
73b72273 0f8557010000    jne     iccvid+0x23d0 (73b723d0)                [br=0]
0:013> p
eax=00000011 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b72279 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2279:
73b72279 8d4508          lea     eax,[ebp+8]
0:013> p
eax=137bfd38 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b7227c esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x227c:
73b7227c 50              push    eax
0:013> p
eax=137bfd38 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b7227d esp=137bfd00 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x227d:
73b7227d 6a0c            push    0Ch
0:013> p
eax=137bfd38 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b7227f esp=137bfcfc ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x227f:
73b7227f ff75f8          push    dword ptr [ebp-8]    ss:0023:137bfd28=00000010
0:013> p
eax=137bfd38 ebx=11f4afc0 ecx=00000010 edx=00000010 esi=09e98b12 edi=00000000
eip=73b72282 esp=137bfcf8 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2282:
73b72282 e8fffeffff      call    iccvid+0x2186 (73b72186)
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00000004 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b72287 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2287:
73b72287 85c0            test    eax,eax
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00000004 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b72289 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2289:
73b72289 0f8c65010000    jl      iccvid+0x23f4 (73b723f4)                [br=0]
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00000004 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b7228f esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x228f:
73b7228f 33c0            xor     eax,eax
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00000004 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b72291 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2291:
73b72291 8a6608          mov     ah,byte ptr [esi+8]        ds:0023:09e98b1a=41
0:013> p
eax=00004100 ebx=11f4afc0 ecx=00000004 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b72294 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2294:
73b72294 33c9            xor     ecx,ecx
0:013> p
eax=00004100 ebx=11f4afc0 ecx=00000000 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b72296 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2296:
73b72296 8a6e04          mov     ch,byte ptr [esi+4]        ds:0023:09e98b16=41
0:013> p
eax=00004100 ebx=11f4afc0 ecx=00004100 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b72299 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x2299:
73b72299 8a4609          mov     al,byte ptr [esi+9]        ds:0023:09e98b1b=41
0:013> p
eax=00004141 ebx=11f4afc0 ecx=00004100 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b7229c esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x229c:
73b7229c 8a4e05          mov     cl,byte ptr [esi+5]        ds:0023:09e98b17=41
0:013> p
eax=00004141 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b7229f esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x229f:
73b7229f 2bc1            sub     eax,ecx
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722a1 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22a1:
73b722a1 660faf432e      imul    ax,word ptr [ebx+2Eh]    ds:0023:11f4afee=0001
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722a6 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x22a6:
73b722a6 89450c          mov     dword ptr [ebp+0Ch],eax ss:0023:137bfd3c=00000060
0:013> p
eax=00000000 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722a9 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
iccvid+0x22a9:
73b722a9 8b45fc          mov     eax,dword ptr [ebp-4] ss:0023:137bfd2c=00002000 #首次执行时为0，到后面循环0x2000
```

下面是首次执行时的递增操作，然后跳回循环处理未解压的数据：

```assembly
0:013> p
eax=00000000 ebx=11f4afc0 ecx=09e98b1e edx=00414141 esi=09e98b12 edi=09e98b1e
eip=73b723c7 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
iccvid+0x23c7:
73b723c7 8145fc00200000  add     dword ptr [ebp-4],2000h ss:0023:137bfd2c=00002000
```

继续执行下去还会再次判断Chunk ID是否为0x1100，若是则不跳转，并执行数据复制。在每次循环复制0x800字节数据时，目标地址都会递增0x2000,目标堆块的大小为0x6000，因此只要令ChunkID 0x1100的数据块超过3个即可造成堆溢出。处理第1个0x1100类型的Chunk时:

```assembly
0:013> p
eax=00002000 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722b6 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22b6:
73b722b6 803e11          cmp     byte ptr [esi],11h         ds:0023:09e98b12=11 #判断Chunk ID是否为0x0011
0:013> p
eax=00002000 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722b9 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22b9:
73b722b9 7516            jne     iccvid+0x22d1 (73b722d1)                [br=0]
0:013> p
eax=00002000 ebx=11f4afc0 ecx=00004141 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722bb esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22bb:
73b722bb 8b4b1c          mov     ecx,dword ptr [ebx+1Ch] ds:0023:11f4afdc=11f4d000
0:013> p
eax=00002000 ebx=11f4afc0 ecx=11f4d000 edx=137bfd38 esi=09e98b12 edi=00000000
eip=73b722be esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22be:
73b722be 8d3c01          lea     edi,[ecx+eax]	#目标地址每次递增0x2000
0:013> p
eax=00002000 ebx=11f4afc0 ecx=11f4d000 edx=137bfd38 esi=09e98b12 edi=11f4f000
eip=73b722c1 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22c1:
73b722c1 b900080000      mov     ecx,800h
0:013> p
eax=00002000 ebx=11f4afc0 ecx=00000800 edx=137bfd38 esi=09e98b12 edi=11f4f000
eip=73b722c6 esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22c6:
73b722c6 8db700e0ffff    lea     esi,[edi-2000h]
0:013> p
eax=00002000 ebx=11f4afc0 ecx=00000800 edx=137bfd38 esi=11f4d000 edi=11f4f000
eip=73b722cc esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22cc:
73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi]	#复制数据
```

处理第二个

```assembly
0:013> p
eax=00004000 ebx=11f4afc0 ecx=00000800 edx=137bfd38 esi=11f4f000 edi=11f51000
eip=73b722cc esp=137bfd04 ebp=137bfd30 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
iccvid+0x22cc:
73b722cc f3a5            rep movs dword ptr es:[edi],dword ptr [esi]
```

以此类推，目标地址每次递增0x2000，而其堆块大小为0x6000，由于程序未限制循环递增的次数，当超过3次时就会超出目标堆的大小，最终造成堆溢出!
分析总结:程序在处理Cinepak压缩数据时，当CVID数据长度≥0x20，编码条数量超过3个时，若编码条中Chunk ID为0x1100的CVID Chunk≥3个，同时每次循环操作时未解压的数据超过0x16,那么在复制数据时就可导致堆溢出，因为目标地址每次操作时都会递增0x2000(首次为0)，而其大小只有0x6000，循环递增3次后就会导致堆溢出。

## 漏洞利用

由于每次堆块内存数据复制时的复制数据长度(ecx)固定为0x800*4=0x2000字节，而超出0x6000字节堆块数据区域之后的0x2000字节内存包含一段内存状态(State)为MEM_RESERVE的内存，会造成内存访问异常，所以无法控制EIP。

参考资料：

《漏洞战争》

[CVE-2010-2553微软官方](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2010/ms10-055)

[Sp4n9x师傅：CVE-2010-2553复现与分析](https://sp4n9x.github.io/2021/01/10/CVE-2010-2553%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/#)
